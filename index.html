<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TurvaGPS - Tark S√µiduassistent</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #303f9f;
            --accent-color: #3f51b5;
            --warning-color: #ff5722;
            --success-color: #4caf50;
            --light-color: #e8eaf6;
            --dark-color: #0d1533;
            --text-color: #333;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.75rem 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .app-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
        }
        
        .map-container {
            flex: 1;
            position: relative;
            min-height: 50vh;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .controls-panel {
            background-color: white;
            padding: 1rem;
            overflow-y: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            z-index: 500;
            max-height: 45vh;
        }
        
        .location-permission {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, var(--light-color), #f5f5f5);
            border-radius: 12px;
            margin-bottom: 1rem;
        }
        
        .location-permission h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .route-planner {
            margin-bottom: 1rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-color), #f5f5f5);
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        
        .route-planner h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .route-inputs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .input-group {
            display: flex;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .input-group input {
            flex: 1;
            padding: 0.75rem;
            border: none;
            outline: none;
            font-size: 1rem;
            background: white;
        }
        
        .input-label {
            display: flex;
            align-items: center;
            padding: 0 1rem;
            background-color: #f5f5f5;
            color: #666;
            font-weight: 500;
            min-width: 60px;
        }
        
        .route-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
            touch-action: manipulation;
        }
        
        button:hover {
            background-color: var(--dark-color);
            transform: translateY(-1px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button.secondary {
            background-color: #757575;
        }
        
        button.secondary:hover {
            background-color: #616161;
        }
        
        button.warning {
            background-color: var(--warning-color);
        }
        
        button.warning:hover {
            background-color: #e64a19;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #388e3c;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .speed-display {
            text-align: center;
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-color), #f5f5f5);
            border-radius: 12px;
            border: 2px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        
        .current-speed {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
            transition: color 0.3s ease;
        }
        
        .speed-unit {
            font-size: 1rem;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
        }
        
        .speed-limit {
            font-size: 1.2rem;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .speed-over {
            color: var(--warning-color) !important;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .route-info {
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, var(--light-color), #f5f5f5);
            border-radius: 12px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        
        .route-info h3 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .route-details {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .route-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .route-item:last-child {
            border-bottom: none;
        }
        
        .progress-container {
            margin: 1rem 0;
        }
        
        .progress-bar {
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #8bc34a);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }
        
        .alerts-panel {
            margin: 1rem 0;
        }
        
        .alerts-panel h3 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background-color: #fff3e0;
            border-left: 4px solid var(--warning-color);
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            font-size: 0.9rem;
        }
        
        .alert-icon {
            font-size: 1rem;
        }
        
        .alert-item.police {
            background-color: #e8eaf6;
            border-left-color: var(--primary-color);
        }
        
        .alert-item.camera {
            background-color: #e0f2f1;
            border-left-color: var(--success-color);
        }
        
        .alert-item.construction {
            background-color: #fff8e1;
            border-left-color: #ffa000;
        }
        
        .settings-panel {
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
        }
        
        .settings-panel h3 {
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .speed-warning {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, var(--warning-color), #ff7043);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 2000;
            display: none;
            animation: blink 0.8s infinite alternate;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 3px solid white;
        }
        
        @keyframes blink {
            from { 
                opacity: 1; 
                transform: translate(-50%, -50%) scale(1);
            }
            to { 
                opacity: 0.8; 
                transform: translate(-50%, -50%) scale(1.05);
            }
        }
        
        .voice-alert {
            position: fixed;
            bottom: 15px;
            right: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.75rem;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }
        
        .voice-alert.muted {
            background: linear-gradient(135deg, #757575, #9e9e9e);
        }
        
        .notification {
            position: fixed;
            top: 80px;
            right: 15px;
            background-color: var(--success-color);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            max-width: 250px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .search-result-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.9rem;
        }
        
        .search-result-item:hover {
            background-color: #f5f5f5;
        }
        
        .search-result-item:last-child {
            border-bottom: none;
        }
        
        @media (min-width: 768px) {
            .app-container {
                flex-direction: row;
            }
            
            .controls-panel {
                width: 350px;
                max-height: none;
                box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            }
            
            .map-container {
                min-height: auto;
            }
        }
        
        .route-marker {
            background-color: var(--accent-color);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .user-marker {
            background-color: var(--success-color);
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
        }
        
        .start-marker {
            background-color: #4caf50;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .end-marker {
            background-color: #ff5722;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .custom-popup {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.9rem;
        }
        
        .popup-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
            color: var(--primary-color);
        }
        
        .popup-details {
            font-size: 0.8rem;
            color: #666;
        }
        
        .driving-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .location-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background-color: #e8f5e9;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .location-status.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span>üó∫Ô∏è</span>
            <h1>TurvaGPS</h1>
        </div>
        <div id="connection-status" style="font-size: 0.8rem; display: flex; align-items: center; gap: 0.5rem;">
            <span style="display: inline-block; width: 8px; height: 8px; background-color: #4caf50; border-radius: 50%;"></span>
            √úhendatud
        </div>
    </header>
    
    <div class="app-container">
        <div class="map-container">
            <div id="map"></div>
            <div class="speed-warning" id="speed-warning">
                <div>KIIRUSE√úLETUS!</div>
                <div>V√µta kiirust maha!</div>
            </div>
            <div class="voice-alert" id="voice-alert" title="H√§√§lhoiatused">
                üîä
            </div>
            <div class="notification" id="notification">
                Tere tulemast TurvaGPS-i!
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="location-permission" id="location-permission">
                <h3>üìç Asukoha luba</h3>
                <p>Rakendus vajab sinu asukoha luba t√∂√∂tamiseks</p>
                <button id="request-location" class="success" style="margin-top: 1rem;">
                    <span>üìç</span> Anna asukoha luba
                </button>
            </div>
            
            <div class="location-status" id="location-status">
                <span>üìç</span>
                <span id="location-text">Asukohta otsin...</span>
            </div>
            
            <div class="route-planner">
                <h3>üöó Teekonna Plaanija</h3>
                <div class="route-inputs">
                    <div style="position: relative;">
                        <div class="input-group">
                            <div class="input-label">Algus</div>
                            <input type="text" id="start-input" placeholder="Vali alguspunkt..." readonly>
                        </div>
                        <div class="search-results" id="start-results"></div>
                    </div>
                    
                    <div style="position: relative;">
                        <div class="input-group">
                            <div class="input-label">L√µpp</div>
                            <input type="text" id="end-input" placeholder="Vali l√µpp-punkt..." readonly>
                        </div>
                        <div class="search-results" id="end-results"></div>
                    </div>
                </div>
                
                <div class="route-buttons">
                    <button id="plan-route" class="success" disabled>
                        <span>üìã</span> Plaanija tee
                    </button>
                    <button id="start-journey" class="secondary" disabled>
                        <span>üöÄ</span> Alusta s√µitu
                    </button>
                </div>
            </div>
            
            <div class="speed-display">
                <div class="current-speed" id="current-speed">0</div>
                <div class="speed-unit">km/h</div>
                <div class="speed-limit" id="speed-limit">
                    <span>üö¶</span> Kiiruspiirang: <span id="speed-limit-value">-</span>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-text">
                        <span>Algus</span>
                        <span id="progress-percent">0%</span>
                        <span>L√µpp</span>
                    </div>
                </div>
            </div>
            
            <div class="route-info">
                <h3>üìä Teekonna info</h3>
                <div class="route-details">
                    <div class="route-item">
                        <span>Vahemaa:</span>
                        <span id="route-distance">-</span>
                    </div>
                    <div class="route-item">
                        <span>Aeg:</span>
                        <span id="route-time">-</span>
                    </div>
                    <div class="route-item">
                        <span>Olek:</span>
                        <span id="journey-status">Ootan luba</span>
                    </div>
                </div>
                
                <div class="driving-controls">
                    <button id="pause-journey" class="secondary" disabled>
                        <span>‚è∏Ô∏è</span> Paus
                    </button>
                    <button id="reset-journey" class="warning">
                        <span>üîÑ</span> L√§htesta
                    </button>
                </div>
            </div>
            
            <div class="alerts-panel">
                <h3>‚ö†Ô∏è Hoiatused</h3>
                <div id="alerts-container">
                    <div class="alert-item">
                        <div class="alert-icon">‚ÑπÔ∏è</div>
                        <div>Oota asukoha laadimist</div>
                    </div>
                </div>
            </div>
            
            <div class="settings-panel">
                <h3>‚öôÔ∏è Seaded</h3>
                <div class="setting-item">
                    <span>Kiiruse hoiatused</span>
                    <input type="checkbox" id="speed-alerts" checked>
                </div>
                <div class="setting-item">
                    <span>H√§√§lhoiatused</span>
                    <input type="checkbox" id="voice-alerts" checked>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Rakenduse peamised muutujad
        let map;
        let userLocation = null;
        let startPoint = null;
        let endPoint = null;
        let currentSpeed = 0;
        let currentSpeedLimit = 50;
        let speedWarningActive = false;
        let voiceAlertsEnabled = true;
        let journeyActive = false;
        let journeyPaused = false;
        let journeyProgress = 0;
        let userMarker;
        let startMarker;
        let endMarker;
        let routeLayer;
        let journeyInterval;
        let locationWatchId = null;
        
        // Eeldefineeritud otsingutulemused
        const searchLocations = [
            { name: "Tallinna vanalinn", lat: 59.4370, lng: 24.7495, type: "Ajalooline koht" },
            { name: "Tartu keskv√§ljak", lat: 58.3806, lng: 26.7220, type: "Keskv√§ljak" },
            { name: "P√§rnu rand", lat: 58.3850, lng: 24.4986, type: "Puhkekoht" },
            { name: "Saaremaa Kuressaare", lat: 58.2528, lng: 22.4850, type: "Linn" },
            { name: "Rakvere loss", lat: 59.3464, lng: 26.3558, type: "Ajalooline koht" },
            { name: "Viljandi j√§rv", lat: 58.3639, lng: 25.5900, type: "Looduskoht" },
            { name: "Tallinna lennujaam", lat: 59.4133, lng: 24.8328, type: "Lennujaam" },
            { name: "Tartu √úlikool", lat: 58.3810, lng: 26.7190, type: "Haridusasutus" },
            { name: "Viru Keskus", lat: 59.4360, lng: 24.7565, type: "Kaubanduskeskus" },
            { name: "Solarise keskus", lat: 59.4322, lng: 24.7689, type: "Kaubanduskeskus" },
            { name: "√úlemiste keskus", lat: 59.4211, lng: 24.7992, type: "Kaubanduskeskus" },
            { name: "Rocca al Mare", lat: 59.4350, lng: 24.6389, type: "Kaubanduskeskus" },
            { name: "Kadriorg", lat: 59.4392, lng: 24.7925, type: "Park" },
            { name: "Lahemaa rahvuspark", lat: 59.5667, lng: 25.8000, type: "Looduskoht" },
            { name: "Narva kindlus", lat: 59.3769, lng: 28.2025, type: "Ajalooline koht" }
        ];
        
        // DOM elemendid
        const currentSpeedElement = document.getElementById('current-speed');
        const speedLimitElement = document.getElementById('speed-limit-value');
        const startInput = document.getElementById('start-input');
        const endInput = document.getElementById('end-input');
        const startResults = document.getElementById('start-results');
        const endResults = document.getElementById('end-results');
        const planRouteButton = document.getElementById('plan-route');
        const startJourneyButton = document.getElementById('start-journey');
        const pauseJourneyButton = document.getElementById('pause-journey');
        const resetJourneyButton = document.getElementById('reset-journey');
        const routeDistanceElement = document.getElementById('route-distance');
        const routeTimeElement = document.getElementById('route-time');
        const journeyStatusElement = document.getElementById('journey-status');
        const progressFillElement = document.getElementById('progress-fill');
        const progressPercentElement = document.getElementById('progress-percent');
        const speedWarningElement = document.getElementById('speed-warning');
        const voiceAlertButton = document.getElementById('voice-alert');
        const notificationElement = document.getElementById('notification');
        const alertsContainer = document.getElementById('alerts-container');
        const speedAlertsCheckbox = document.getElementById('speed-alerts');
        const voiceAlertsCheckbox = document.getElementById('voice-alerts');
        const locationPermissionElement = document.getElementById('location-permission');
        const locationStatusElement = document.getElementById('location-status');
        const locationTextElement = document.getElementById('location-text');
        const requestLocationButton = document.getElementById('request-location');
        
        // Initsialiseeri rakendus
        function initApp() {
            console.log("Rakendus k√§ivitatud");
            
            // Initsialiseeri kaart
            initMap();
            
            // Kuula nuppe
            requestLocationButton.addEventListener('click', requestLocationPermission);
            planRouteButton.addEventListener('click', planRoute);
            startJourneyButton.addEventListener('click', startJourney);
            pauseJourneyButton.addEventListener('click', togglePauseJourney);
            resetJourneyButton.addEventListener('click', resetJourney);
            voiceAlertButton.addEventListener('click', toggleVoiceAlerts);
            
            // Kuula otsingu sisestamist
            startInput.addEventListener('input', function() {
                if (this.value.length > 1) {
                    showSearchSuggestions(this.value, 'start');
                } else {
                    startResults.style.display = 'none';
                }
            });
            
            endInput.addEventListener('input', function() {
                if (this.value.length > 1) {
                    showSearchSuggestions(this.value, 'end');
                } else {
                    endResults.style.display = 'none';
                }
            });
            
            // Kuula seadistusi
            speedAlertsCheckbox.addEventListener('change', updateSettings);
            voiceAlertsCheckbox.addEventListener('change', updateSettings);
            
            // Kontrolli, kas asukoha luba on juba antud
            checkLocationPermission();
            
            // N√§ita teavitust
            showNotification("Tere tulemast TurvaGPS-i!", "success");
        }
        
        // Kontrolli asukoha luba
        function checkLocationPermission() {
            if (navigator.permissions) {
                navigator.permissions.query({name: 'geolocation'}).then(function(result) {
                    if (result.state === 'granted') {
                        // Luba on juba antud
                        startLocationTracking();
                        locationPermissionElement.style.display = 'none';
                    } else if (result.state === 'prompt') {
                        // Luba pole veel antud
                        locationPermissionElement.style.display = 'block';
                    } else {
                        // Luba on keelatud
                        showLocationError("Asukoha luba on keelatud. Palun luba see brauseri seadetest.");
                    }
                });
            } else {
                // Vanemad brauserid, mis ei toeta Permissions API-t
                locationPermissionElement.style.display = 'block';
            }
        }
        
        // K√ºsi asukoha luba
        function requestLocationPermission() {
            locationTextElement.textContent = "Asukohta otsin...";
            locationStatusElement.className = "location-status";
            
            if (!navigator.geolocation) {
                showLocationError("Sinu brauser ei toeta asukoha teenust");
                return;
            }
            
            // K√ºsi asukohta √ºhekordselt
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    // Edukas asukoha saamine
                    handleLocationSuccess(position);
                    locationPermissionElement.style.display = 'none';
                    
                    // Alusta pidevat asukoha j√§lgimist
                    startLocationTracking();
                },
                function(error) {
                    // Viga asukoha saamisel
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }
        
        // Alusta pidevat asukoha j√§lgimist
        function startLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
            }
            
            locationWatchId = navigator.geolocation.watchPosition(
                function(position) {
                    handleLocationSuccess(position);
                },
                function(error) {
                    handleLocationError(error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 10000
                }
            );
        }
        
        // Edukas asukoha saamine
        function handleLocationSuccess(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            userLocation = { lat, lng, accuracy };
            
            // Uuenda kasutaja markerit
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: 'üìç',
                        iconSize: [25, 25],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map).bindPopup(`<div class="custom-popup"><div class="popup-title">Sinu asukoht</div><div class="popup-details">T√§psus: ${Math.round(accuracy)}m</div></div>`);
            }
            
            // Keskenda kaart kasutaja asukohale
            map.setView([lat, lng], 15);
            
            // Uuenda staatust
            locationTextElement.textContent = `Asukoht leitud (t√§psus: ${Math.round(accuracy)}m)`;
            locationStatusElement.className = "location-status";
            
            // Luba sisendv√§ljad
            startInput.readOnly = false;
            endInput.readOnly = false;
            
            // M√§√§ra vaikimisi alguspunkt praeguseks asukohaks
            if (!startPoint) {
                startPoint = {
                    name: "Praegune asukoht",
                    lat: lat,
                    lng: lng,
                    type: "Praegune asukoht"
                };
                startInput.value = "Praegune asukoht";
                checkRouteReady();
            }
            
            showNotification("Asukoht leitud!", "success");
        }
        
        // Viga asukoha saamisel
        function handleLocationError(error) {
            let errorMessage = "Asukoha m√§√§ramise viga: ";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Asukoha luba keelati. Palun luba asukoha kasutamine brauseri seadetest.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Asukoha teave pole saadaval.";
                    break;
                case error.TIMEOUT:
                    errorMessage = "Asukoha p√§ring aegus.";
                    break;
                default:
                    errorMessage = "Tundmatu viga asukoha m√§√§ramisel.";
                    break;
            }
            
            showLocationError(errorMessage);
        }
        
        // N√§ita asukoha viga
        function showLocationError(message) {
            locationTextElement.textContent = message;
            locationStatusElement.className = "location-status error";
            showNotification(message, "warning");
        }
        
        // Kaardi initsialiseerimine
        function initMap() {
            // Loo kaart (alguses keskendatud Eestile)
            map = L.map('map').setView([58.5953, 25.0136], 7);
            
            // Lisa kaardikiht
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            console.log("Kaart initsialiseeritud");
        }
        
        // Otsingusoovituste n√§itamine
        function showSearchSuggestions(query, type) {
            const results = searchLocations.filter(location => 
                location.name.toLowerCase().includes(query.toLowerCase())
            ).slice(0, 5);
            
            const resultsContainer = type === 'start' ? startResults : endResults;
            
            if (results.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            // Kuva tulemused
            resultsContainer.innerHTML = '';
            results.forEach(location => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.innerHTML = `
                    <div style="font-weight: 500;">${location.name}</div>
                    <div style="font-size: 0.8rem; color: #666;">${location.type}</div>
                `;
                item.addEventListener('click', () => {
                    if (type === 'start') {
                        startInput.value = location.name;
                        startPoint = location;
                    } else {
                        endInput.value = location.name;
                        endPoint = location;
                    }
                    resultsContainer.style.display = 'none';
                    
                    // Kontrolli, kas m√µlemad punktid on valitud
                    checkRouteReady();
                });
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.style.display = 'block';
        }
        
        // Kontrolli, kas marsruudi plaanimine on v√µimalik
        function checkRouteReady() {
            if (startPoint && endPoint) {
                planRouteButton.disabled = false;
            } else {
                planRouteButton.disabled = true;
            }
        }
        
        // Marsruudi plaanimine
        function planRoute() {
            if (!startPoint || !endPoint) {
                showNotification("Palun vali nii algus- kui l√µpp-punkt!", "warning");
                return;
            }
            
            console.log("Plaanin marsruuti:", startPoint.name, "->", endPoint.name);
            
            // Eemalda eelmised markerid ja marsruudid
            clearRoute();
            
            // Lisa alguspunkti marker
            startMarker = L.marker([startPoint.lat, startPoint.lng], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: 'üü¢',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(map).bindPopup(`<div class="custom-popup"><div class="popup-title">Alguspunkt</div><div class="popup-details">${startPoint.name}</div></div>`).openPopup();
            
            // Lisa l√µpp-punkti marker
            endMarker = L.marker([endPoint.lat, endPoint.lng], {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: 'üî¥',
                    iconSize: [25, 25],
                    iconAnchor: [12, 12]
                })
            }).addTo(map).bindPopup(`<div class="custom-popup"><div class="popup-title">L√µpp-punkt</div><div class="popup-details">${endPoint.name}</div></div>`);
            
            // Joonista marsruut
            drawRoute();
            
            // Arvuta marsruudi info
            updateRouteInfo();
            
            // Aktiveeri s√µidu alustamise nupp
            startJourneyButton.disabled = false;
            
            // Lisa hoiatused marsruudile
            addRouteAlerts();
            
            // N√§ita teavitust
            showNotification(`Marsruut plaanitud: ${startPoint.name} ‚Üí ${endPoint.name}`, "success");
        }
        
        // Marsruudi joonistamine
        function drawRoute() {
            // Eemalda eelmine marsruut
            if (routeLayer) {
                map.removeLayer(routeLayer);
            }
            
            if (!startPoint || !endPoint) return;
            
            // Lihtne marsruudi simulatsioon
            const routeCoordinates = [
                [startPoint.lat, startPoint.lng],
                [endPoint.lat, endPoint.lng]
            ];
            
            routeLayer = L.polyline(routeCoordinates, {
                color: '#3f51b5',
                weight: 4,
                opacity: 0.7,
                lineJoin: 'round'
            }).addTo(map);
            
            // Kohanda kaardi vaadet
            map.fitBounds([
                [startPoint.lat, startPoint.lng],
                [endPoint.lat, endPoint.lng]
            ], { padding: [20, 20] });
        }
        
        // Marsruudi info uuendamine
        function updateRouteInfo() {
            if (!startPoint || !endPoint) return;
            
            // Arvuta vahemaa
            const distance = calculateDistance(startPoint, endPoint);
            
            // Vorminda vahemaa
            let distanceText;
            if (distance < 1) {
                distanceText = `${Math.round(distance * 1000)} m`;
            } else {
                distanceText = `${distance.toFixed(1)} km`;
            }
            
            // Arvuta aeg (eeldades keskmist kiirust 60 km/h)
            const timeMinutes = Math.round(distance / 60 * 60);
            
            // Vorminda aeg
            let timeText;
            if (timeMinutes < 60) {
                timeText = `${timeMinutes} min`;
            } else {
                const hours = Math.floor(timeMinutes / 60);
                const minutes = timeMinutes % 60;
                timeText = minutes > 0 ? `${hours} h ${minutes} min` : `${hours} h`;
            }
            
            routeDistanceElement.textContent = distanceText;
            routeTimeElement.textContent = timeText;
            journeyStatusElement.textContent = "Marsruut plaanitud";
        }
        
        // S√µidu alustamine
        function startJourney() {
            if (!startPoint || !endPoint) return;
            
            console.log("Alustan s√µitu");
            
            journeyActive = true;
            journeyPaused = false;
            journeyProgress = 0;
            
            // Uuenda UI-d
            journeyStatusElement.textContent = "S√µidan...";
            startJourneyButton.disabled = true;
            pauseJourneyButton.disabled = false;
            pauseJourneyButton.innerHTML = '<span>‚è∏Ô∏è</span> Paus';
            
            // K√§ivita s√µidu simulatsioon
            startJourneySimulation();
            
            // N√§ita teavitust
            showNotification("S√µit algas! J√§lgi oma kiirust.", "success");
        }
        
        // S√µidu simulatsioon
        function startJourneySimulation() {
            clearInterval(journeyInterval);
            
            journeyInterval = setInterval(() => {
                if (!journeyActive || journeyPaused) return;
                
                // Suurenda edenemist
                journeyProgress += 0.5;
                
                // Kui j√µudsime sihtkohta
                if (journeyProgress >= 100) {
                    journeyProgress = 100;
                    completeJourney();
                }
                
                // Uuenda edenemisriba
                progressFillElement.style.width = `${journeyProgress}%`;
                progressPercentElement.textContent = `${Math.round(journeyProgress)}%`;
                
                // Liiguta kasutajat m√∂√∂da marsruuti
                if (startPoint && endPoint) {
                    const progress = journeyProgress / 100;
                    userLocation.lat = startPoint.lat + (endPoint.lat - startPoint.lat) * progress;
                    userLocation.lng = startPoint.lng + (endPoint.lng - startPoint.lng) * progress;
                    if (userMarker) {
                        userMarker.setLatLng([userLocation.lat, userLocation.lng]);
                    }
                }
                
                // Simuleeri kiiruse muutumist
                simulateSpeedChange();
                
            }, 500);
        }
        
        // Kiiruse muutumise simulatsioon
        function simulateSpeedChange() {
            // Muuda kiirust juhuslikult, kuid j√§rgides marsruudi iseloomu
            let speedChange;
            
            // Erinevad kiirused s√µltuvalt teekonna osast
            if (journeyProgress < 20) {
                // Alguses kiirendamine
                speedChange = Math.random() * 5 + 2;
            } else if (journeyProgress > 80) {
                // L√µpus aeglustamine
                speedChange = Math.random() * 3 - 4;
            } else {
                // Keskmine s√µit - varieeruv kiirus
                speedChange = Math.random() * 8 - 4;
            }
            
            currentSpeed = Math.max(0, currentSpeed + speedChange);
            
            // M√µnikord muuda kiiruspiirangut
            if (Math.random() < 0.1) {
                const limits = [30, 50, 70, 90];
                currentSpeedLimit = limits[Math.floor(Math.random() * limits.length)];
            }
            
            // Uuenda kiiruse kuvamist
            currentSpeedElement.textContent = Math.round(currentSpeed);
            speedLimitElement.textContent = currentSpeedLimit;
            
            // Kontrolli kiiruse√ºletust
            checkSpeedViolation();
        }
        
        // S√µidu peatamine/j√§tkamine
        function togglePauseJourney() {
            if (!journeyActive) return;
            
            journeyPaused = !journeyPaused;
            
            if (journeyPaused) {
                pauseJourneyButton.innerHTML = '<span>‚ñ∂Ô∏è</span> J√§tka';
                journeyStatusElement.textContent = "Peatatud";
                showNotification("S√µit peatatud", "info");
            } else {
                pauseJourneyButton.innerHTML = '<span>‚è∏Ô∏è</span> Paus';
                journeyStatusElement.textContent = "S√µidan...";
                showNotification("S√µit j√§tkub", "success");
            }
        }
        
        // S√µidu l√µpetamine
        function completeJourney() {
            journeyActive = false;
            journeyPaused = false;
            
            clearInterval(journeyInterval);
            
            // Uuenda UI-d
            journeyStatusElement.textContent = "Sihtkohas!";
            startJourneyButton.disabled = true;
            pauseJourneyButton.disabled = true;
            
            // N√§ita teavitust
            showNotification("√ïnnitlused! Olete j√µudnud sihtkohta.", "success");
        }
        
        // S√µidu l√§htestamine
        function resetJourney() {
            journeyActive = false;
            journeyPaused = false;
            journeyProgress = 0;
            
            clearInterval(journeyInterval);
            
            // L√§htesta kiirus
            currentSpeed = 0;
            currentSpeedElement.textContent = "0";
            
            // L√§htesta edenemisriba
            progressFillElement.style.width = "0%";
            progressPercentElement.textContent = "0%";
            
            // L√§htesta UI
            journeyStatusElement.textContent = "M√§√§ramata";
            startJourneyButton.disabled = !(startPoint && endPoint);
            pauseJourneyButton.disabled = true;
            pauseJourneyButton.innerHTML = '<span>‚è∏Ô∏è</span> Paus';
            
            // Peida kiiruse hoiatus
            speedWarningElement.style.display = 'none';
            currentSpeedElement.classList.remove('speed-over');
            
            showNotification("S√µit l√§htestatud", "info");
        }
        
        // Marsruudi eemaldamine
        function clearRoute() {
            // Eemalda markerid
            if (startMarker) {
                map.removeLayer(startMarker);
                startMarker = null;
            }
            
            if (endMarker) {
                map.removeLayer(endMarker);
                endMarker = null;
            }
            
            // Eemalda marsruut
            if (routeLayer) {
                map.removeLayer(routeLayer);
                routeLayer = null;
            }
            
            // L√§htesta punktid
            startPoint = null;
            endPoint = null;
            startInput.value = '';
            endInput.value = '';
            
            // L√§htesta marsruudi info
            routeDistanceElement.textContent = '-';
            routeTimeElement.textContent = '-';
            
            // Keela nupud
            planRouteButton.disabled = true;
            startJourneyButton.disabled = true;
            
            // L√§htesta s√µit
            resetJourney();
        }
        
        // Kauguse arvutamine kahe punkti vahel
        function calculateDistance(point1, point2) {
            const R = 6371; // Maa raadius km
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLon = (point2.lng - point1.lng) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        // Kiiruse√ºletuse kontroll
        function checkSpeedViolation() {
            const speedAlertsEnabled = speedAlertsCheckbox.checked;
            
            if (speedAlertsEnabled && currentSpeed > currentSpeedLimit) {
                // N√§ita hoiust
                speedWarningElement.style.display = 'block';
                currentSpeedElement.classList.add('speed-over');
                
                // K√§ivita h√§√§lhoiatus
                if (voiceAlertsEnabled && !speedWarningActive) {
                    playSpeedWarning();
                    speedWarningActive = true;
                }
            } else {
                // Peida hoiatus
                speedWarningElement.style.display = 'none';
                currentSpeedElement.classList.remove('speed-over');
                speedWarningActive = false;
            }
        }
        
        // Kiiruse√ºletuse h√§√§lehoiatus
        function playSpeedWarning() {
            if (!voiceAlertsEnabled) return;
            
            playVoiceAlert(`Hoiatus! Liigud kiirusega ${Math.round(currentSpeed)} kilomeetrit tunnis. Kiiruspiirang on ${currentSpeedLimit}. V√µta kiirust maha!`);
        }
        
        // √úldine h√§√§lteate esitamine
        function playVoiceAlert(message) {
            if (!voiceAlertsEnabled) return;
            
            // Kasuta Text-to-Speech'i kui see on saadaval
            if ('speechSynthesis' in window) {
                // Peata k√µik eelmised k√µned
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = 'et-EE';
                utterance.rate = 1.0;
                utterance.volume = 0.8;
                speechSynthesis.speak(utterance);
            }
        }
        
        // Marsruudil olevate hoiatusete lisamine
        function addRouteAlerts() {
            if (!startPoint || !endPoint) return;
            
            alertsContainer.innerHTML = '';
            
            const alerts = [
                { type: 'police', text: 'Politsei kontroll 2 km jooksul', icon: 'üöì' },
                { type: 'camera', text: 'Kiiruskaamera 5 km jooksul', icon: 'üìπ' },
                { type: 'construction', text: 'Tee-ehitus 8 km jooksul', icon: 'üöß' }
            ];
            
            alerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = `alert-item ${alert.type}`;
                alertElement.innerHTML = `
                    <div class="alert-icon">${alert.icon}</div>
                    <div>${alert.text}</div>
                `;
                alertsContainer.appendChild(alertElement);
            });
        }
        
        // H√§√§lhoiatusete l√ºlitamine
        function toggleVoiceAlerts() {
            voiceAlertsEnabled = !voiceAlertsEnabled;
            voiceAlertsCheckbox.checked = voiceAlertsEnabled;
            
            if (voiceAlertsEnabled) {
                voiceAlertButton.classList.remove('muted');
                voiceAlertButton.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
            } else {
                voiceAlertButton.classList.add('muted');
                voiceAlertButton.style.background = 'linear-gradient(135deg, #757575, #9e9e9e)';
                // Peata k√µik k√µned
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }
        }
        
        // Seadete uuendamine
        function updateSettings() {
            voiceAlertsEnabled = voiceAlertsCheckbox.checked;
            
            // V√§rskenda h√§√§lteate nupu olekut
            if (voiceAlertsEnabled) {
                voiceAlertButton.classList.remove('muted');
                voiceAlertButton.style.background = 'linear-gradient(135deg, var(--primary-color), var(--secondary-color))';
            } else {
                voiceAlertButton.classList.add('muted');
                voiceAlertButton.style.background = 'linear-gradient(135deg, #757575, #9e9e9e)';
            }
            
            // Peata hoiatused kui need on v√§lja l√ºlitatud
            if (!speedAlertsCheckbox.checked) {
                speedWarningElement.style.display = 'none';
                currentSpeedElement.classList.remove('speed-over');
            }
        }
        
        // Teavituse n√§itamine
        function showNotification(message, type = "info") {
            notificationElement.textContent = message;
            
            // M√§√§ra taustav√§rv vastavalt t√º√ºbile
            if (type === "success") {
                notificationElement.style.backgroundColor = "var(--success-color)";
            } else if (type === "warning") {
                notificationElement.style.backgroundColor = "var(--warning-color)";
            } else {
                notificationElement.style.backgroundColor = "var(--accent-color)";
            }
            
            notificationElement.style.display = "block";
            
            // Peida teavitus 3 sekundi p√§rast
            setTimeout(() => {
                notificationElement.style.display = "none";
            }, 3000);
        }
        
        // K√§ivita rakendus
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
